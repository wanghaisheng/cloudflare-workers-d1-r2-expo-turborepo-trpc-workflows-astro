# 项目架构总览

## 架构设计理念

本项目采用现代化的分布式架构，基于Cloudflare的边缘计算平台构建，旨在提供高性能、可扩展且安全的全栈移动应用解决方案。架构设计遵循以下原则：

- **边缘优先**: 利用Cloudflare的全球网络，将计算和数据存储尽可能靠近用户
- **类型安全**: 通过TypeScript和tRPC实现端到端类型安全
- **模块化**: 使用Turborepo管理的monorepo结构，实现代码共享和独立部署
- **无服务器**: 采用Cloudflare Workers和D1数据库，无需管理服务器

## 核心技术栈

### 前端技术

- **Expo (React Native)**: 用于构建跨平台移动应用
- **Astro**: 用于构建高性能静态网站/落地页
- **Tailwind CSS**: 用于一致的UI设计系统
- **Clerk**: 用于用户认证和管理

### 后端技术

- **Cloudflare Workers**: 无服务器计算平台
- **Cloudflare D1**: 边缘SQLite数据库
- **Cloudflare R2**: 对象存储服务
- **Cloudflare Workers AI**: 边缘AI处理能力
- **Cloudflare Workflows**: 持久化任务处理

### 开发工具

- **Turborepo**: Monorepo构建系统
- **PNPM**: 包管理器
- **TypeScript**: 静态类型检查
- **Drizzle ORM**: 类型安全的ORM
- **tRPC**: 端到端类型安全的API

## 分层架构

项目采用清晰的分层架构，各层职责明确：

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端应用层                           │
│  ┌───────────────┐            ┌───────────────────────┐    │
│  │  Expo移动应用  │            │  Astro静态网站/落地页  │    │
│  └───────┬───────┘            └───────────┬───────────┘    │
└──────────┼──────────────────────────────┬─┴────────────────┘
           │                              │
           │ tRPC客户端                   │ HTTP请求
           ▼                              ▼
┌──────────────────────────────────────────────────────────┐
│                       API服务层                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │              Cloudflare Worker API                  │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │  │
│  │  │  tRPC路由   │  │ 中间件/验证 │  │ 错误处理   │  │  │
│  │  └─────────────┘  └─────────────┘  └────────────┘  │  │
│  └────────────────────────────────────────────────────┘  │
└───────────────────────────┬──────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────┐
│                      服务/业务逻辑层                      │
│  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐ │
│  │ 用户服务    │  │ 内容服务    │  │ AI处理服务        │ │
│  └─────────────┘  └─────────────┘  └───────────────────┘ │
└───────────────────────────┬──────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────┐
│                        数据访问层                         │
│  ┌─────────────┐  ┌─────────────┐  ┌───────────────────┐ │
│  │ D1数据库    │  │ R2存储      │  │ 外部API集成       │ │
│  │ (Drizzle ORM)│  │ (对象存储)  │  │                   │ │
│  └─────────────┘  └─────────────┘  └───────────────────┘ │
└──────────────────────────────────────────────────────────┘
```

## 数据流

### 请求流程

1. **客户端请求**: 移动应用或网站通过tRPC客户端或HTTP请求发起API调用
2. **API路由**: Cloudflare Worker接收请求并路由到相应的tRPC处理程序
3. **中间件处理**: 验证请求、检查认证状态、应用速率限制等
4. **业务逻辑**: 执行相应的业务逻辑，调用服务层
5. **数据访问**: 通过Drizzle ORM访问D1数据库或通过R2 API访问存储
6. **响应返回**: 将处理结果返回给客户端

### 异步任务流程

对于需要长时间处理的任务（如AI处理）：

1. **任务提交**: 客户端提交任务请求
2. **任务排队**: API服务将任务提交到Cloudflare Workflows
3. **异步处理**: Workflows执行任务，可能调用Workers AI或其他服务
4. **状态更新**: 处理结果写入数据库
5. **客户端轮询**: 客户端通过API查询任务状态和结果

## 模块职责

### 前端模块

- **Expo移动应用**: 提供用户主要交互界面，包含认证、内容展示和功能操作
- **Astro网站**: 提供项目介绍、用户注册入口和营销内容

### 后端模块

- **API服务**: 处理所有客户端请求，实现业务逻辑和数据操作
- **数据库模块**: 定义数据结构、关系和访问方法
- **存储服务**: 管理用户上传的文件和应用资源
- **Workflows**: 处理需要长时间运行的任务和复杂处理流程

### 共享模块

- **tRPC定义**: 提供API类型定义，确保前后端类型一致性
- **通用工具**: 提供日期处理、格式化、验证等通用功能

## 安全架构

- **认证**: 使用Clerk进行用户认证和会话管理
- **授权**: 基于用户角色和权限的访问控制
- **数据验证**: 使用Zod进行请求数据验证
- **边缘安全**: 利用Cloudflare的DDoS保护和WAF功能

## 扩展性考虑

- **水平扩展**: Cloudflare Workers自动扩展以处理增加的负载
- **功能模块化**: 新功能可以作为独立的tRPC路由和服务添加
- **多区域部署**: 利用Cloudflare的全球网络实现低延迟访问

## 技术集成关系

- **tRPC + TypeScript**: 确保API类型安全和开发体验
- **Drizzle + D1**: 提供类型安全的数据库访问
- **Expo + tRPC客户端**: 实现移动应用与后端的无缝集成
- **Clerk + Workers**: 提供安全的认证和授权机制

通过这种架构设计，项目能够提供高性能、可靠且可扩展的用户体验，同时保持开发效率和代码质量。